---
title: Azure SQL Managed Instance上で透過的なデータベース暗号化(TDE)
により保護されたデータベースのCOPY_ONLYバックアップをとる
date: 2024-08-28 9:00
tags:
  - Management
  - SQL Managed Instance
  - TDE
  - COPY_ONLYバックアップ
---

こんにちは。SQL Cloud サポート チームの太田です。

今回の投稿では、Azure SQL Managed Instance (SQL MI) 上でTDE保護されたデータベースのCOPY_ONLYバックアップをとる方法をご紹介します。

<!-- more -->

TDE（Transparent Data Encryption）は、Azure SQL Database（Single DatabaseおよびManaged Instance）のセキュリティ機能で、メモリと基礎となるストレージの間でやり取りされるページを透過的に暗号化します。



Azure SQL Database Managed Instanceは、完全に暗号化されたAzureストレージ上に保存される自動バックアップを備えており、コンプライアンスを維持し、必要な機能のほとんどを提供します。また、Managed Instanceでは、独自のCOPY_ONLYバックアップを取ることもできます。これは、組み込みの自動バックアップと比較すると用途は限られますが、有用な場合もあります（例えば、バックアップの保持期間を過ぎても有効期限が切れないバックアップを保持する場合など）。

 

ただし、Managed Instance でサービス管理キーを使用するTDE保護されたデータベースでは、手動でCOPY_ONLYバックアップを取ることはできません。COPY_ONLYバックアップは、高い権限を持つ人がデータを取得することを可能にし、セキュリティポリシーに違反する可能性があります。SQL Serverでは、TDEで保護されたデータベースのバックアップを自分で取ることができますが、これには保護キーをエクスポートするプロセスが含まれます。

 

`[!WARNING]`
一般的には、自動バックアップのみを使用することが推奨されます。自動リストア機能により、ある時点のデータベースをリストアしたり、別のインスタンスにデータベースをリストアしたり（本番環境から開発環境へのリストアなど）、あるいはgeoリストア機能によりデータベースを移行することができます。これらの自動バックアップは、最大35日間保存することが可能です。これらのビルトイン自動バックアップは安全であり、完全なコンプライアンスを実現します。このシナリオにおけるCOPY_ONLYバックアップは特定の場合にのみ使用されます。別の方法として、Azureのクラウドベースのキー管理システムであるAzure Key Vaultに保存されたTDE保護機能を使用することもできます。Azure Key Vaultにキーを入れておけば、リストア後に自分のキーで復号化できるバックアップを取ることができます。しかし、キーを削除すると、バックアップは復号化できなくなります。

厳格なTDE保護では、独自のカスタムバックアップを取ることはできません。TDE で保護されたデータベースのバックアップが必要な場合は、TDE を一時的に無効にしてバックアップを取り、TDE を再度有効にする必要があります。

`[NOTE]`
場合によっては、組み込みのインスタンス間でのリストアを使用して別のインスタンス上にデータベースのコピーを作成し、そこで TDE をオフにして元のインスタンスに準拠させることができます。

ただし、この場合でも、データベース内に暗号化されたページがないことを確認し、復号化が完了するのを待ってからバックアップを取る必要があります。復号化が完了する前にデータベースをバックアップすると、別のインスタンスでバックアップを復元しようとしたときに以下のエラーが発生する可能性があります：
 
**33111** Cannot find server certificate with thumbprint ...
 
マネージド・インスタンスでデータベースをバックアップおよびリストアする推奨の方法は、組み込みの自動バックアップとインスタンス間のポイントインタイムリストアを使用することです。
ただし、手動バックアップを使用する必要がある場合は、以下の手順に従ってください：
 
1. DB が TDE で暗号化されているかどうかを確認する：
```sql
Select * from sys.dm_database_encryption_keys
```
2. データベースが暗号化されている場合、暗号化をオフにするようにデータベースを変更する。この操作を実行するとき、アクティブなトランザクションがないことを確認する：
```sql
Alter database <dbName> set encryption Off
```
3. データベースのチェックポイントを実行します：
```sql
Checkpoint
```
4. データベース暗号化キー(DEK)を削除します：
```sql
DROP DATABASE ENCRYPTION KEY
```
5. ログを切り捨てます：
```sql
DBCC SHRINKFILE (  <logName>, 1)
```
6. 
```sql
select * from sys.dm_db_log_info 
```
を実行します。これで、サムプリントで暗号化されたアクティブなVLFは表示されません。
7. バックアップを取ります。
8. バックアップを復元し、証明書を要求しないことを確認します。
